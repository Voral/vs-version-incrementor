# Семантическое обновление версии

[EN](https://github.com/Voral/vs-version-incrementor/blob/master/README.md)

[![Scrutinizer Code Quality](https://scrutinizer-ci.com/g/Voral/vs-version-incrementor/badges/quality-score.png?b=master)](https://scrutinizer-ci.com/g/Voral/vs-version-incrementor/?branch=master)
[![Code Coverage](https://scrutinizer-ci.com/g/Voral/vs-version-incrementor/badges/coverage.png?b=master)](https://scrutinizer-ci.com/g/Voral/vs-version-incrementor/?branch=master)
[![Code Intelligence Status](https://scrutinizer-ci.com/g/Voral/vs-version-incrementor/badges/code-intelligence.svg?b=master)](https://scrutinizer-ci.com/code-intelligence) \
![PHP Tests](https://github.com/Voral/vs-version-incrementor/actions/workflows/php.yml/badge.svg)

Этот инструмент автоматизирует процесс управления версиями в проектах на основе Composer, анализируя Git-коммиты и
генерируя `CHANGELOG`. Он соответствует стандарту [семантического версионирования](https://semver.org/) и поддерживает
спецификацию [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/).

Версия следует семантическому правилу `<Major>.<Minor>.<Patch>`:

- *Major*: Изменения, нарушающие обратную совместимость.
- *Minor*: Добавление новых функций без нарушения существующей функциональности.
- *Patch*: Исправления ошибок или незначительные улучшения.

## Основные возможности

- **Управление версиями**: Автоматически определяет следующую версию на основе анализа коммитов и
  обновляет `composer.json`.
- **Интеграция с Git**: Создает Git-теги для релизов и управляет коммитами в соответствии со стратегией версионирования
  проекта.
- **Настраиваемые типы коммитов**: Определение пользовательских типов коммитов и их влияния на увеличение
  версий (`major`, `minor`, `patch`).
- **Расширенная генерация CHANGELOG**:
    - Поддержка пользовательского форматирования файла `CHANGELOG.md`.
    - Возможность скрывать повторяющиеся записи в рамках одной секции для более чистого вывода.
    - Настройка сохранения скоупов для определенных типов коммитов.
- **Поддержка сквошенных коммитов**: Обрабатывает сквошенные коммиты (например, из `git merge --squash`), разбирая
  детальные описания.
- **Настраиваемые правила**: Реализация пользовательских правил для категоризации коммитов по секциям.
- **Гибкая конфигурация**:
    - Настройка имени основной ветки (например, `main` вместо `master`).
    - Конфигурация параметров релизов, таких как скоуп и секция.
    - Игнорирование неотслеживаемых файлов при обновлении версий.
- **Соответствие семантическому версионированию**: Обеспечивает строгое соблюдение принципов семантического
  версионирования.
- **Необязательное обновление в composer.json**: Отключение обновления версий в `composer.json`, если версионирование
  осуществляется только через Git-теги.
- **Расширяемость**:
    - Использование пользовательских парсеров, форматтеров и исполнителей VCS для сложных рабочих процессов.
    - Расширение функциональности с помощью пользовательских свойств через класс `Config`.

### Зачем использовать этот инструмент?

- Упрощает управление версиями, автоматизируя рутинные задачи.
- Улучшает согласованность в версионировании и генерации CHANGELOG.
- Предоставляет гибкость для пользовательских рабочих процессов и специфических требований проекта.
- Снижает вероятность человеческих ошибок, полагаясь на автоматический анализ сообщений коммитов.

## Установка

```bash
composer require --dev voral/version-increment
```

### Использование

Примеры использования утилиты

```bash
# Автоматическое определение типа релиза
./vendor/bin/vs-version-increment

# Увеличение мажорной версии
./vendor/bin/vs-version-increment major

# Увеличение минорной версии
./vendor/bin/vs-version-increment minor

# Увеличение патч-версии
./vendor/bin/vs-version-increment patch
```

Вызов справки по использованию утилиты

```bash
./vendor/bin/vs-version-increment --help
```

Получение списка зарегистрированных типов коммита и зарегистрированных скоупов

```bash
./vendor/bin/vs-version-increment --list
```

Флаг `--debug` позволяет предварительно просмотреть изменения, которые будут внесены в CHANGELOG и версию, без их
реального применения.

```bash
# Автоматическое определение типа релиза
./vendor/bin/vs-version-increment --debug

# Увеличение мажорной версии
./vendor/bin/vs-version-increment --debug major

# Увеличение минорной версии
./vendor/bin/vs-version-increment --debug minor

# Увеличение патч-версии
./vendor/bin/vs-version-increment --debug patch
```

Для упрощения можно добавить скрипты в composer.json

```json
{
  "scripts": {
    "vinc:major": "php ./vendor/bin/vs-version-increment major",
    "vinc:minor": "php ./vendor/bin/vs-version-increment minor",
    "vinc:patch": "php ./vendor/bin/vs-version-increment patch",
    "vinc:auto": "php ./vendor/bin/vs-version-increment",
    "vinc:list": "php ./vendor/bin/vs-version-increment --list",
    "vinc:debug:auto": "php ./vendor/bin/vs-version-increment --debug"
  }
}
```

Пример выходного файла

```bash

# 1.0.1 (2023-10-01)

### Features
- New endpoint user authentication
- Added support dark mode

### Fixes
- Fixed a bug with login form validation
- Resolved issue with incorrect API response

### Other
- Updated dependencies
```

## Конфигурирование

Вы можете конфигурировать скрипт. Путем размещения в каталоге проекта файла `.vs-version-increment.php`  и выполнения в
нем следующих настроек

- [Установка своего списка типов изменений](docs/config.ru.md#установка-своего-списка-типов-изменений)
- [Настройка типа изменения](docs/config.ru.md#настройка-типа-изменения)
- [Настройка типа для релизов](docs/config.ru.md#настройка-типа-для-релизов)
- [Конфигурирование основной ветки репозитория](docs/config.ru.md#конфигурирование-основной-ветки-репозитория)
- [Настройка типов для Мажорной версии](docs/config.ru.md#настройка-типов-для-мажорной-версии)
- [Настройка типов для Минорной версии](docs/config.ru.md#настройка-типов-для-минорной-версии)
- [Настройка релизной группы](docs/config.ru.md#настройка-релизной-группы)
- [Настройка собственных правил распределения по типам](docs/config.ru.md#настройка-собственных-правил-распределения-по-типам)
- [Игнорирование не отслеживаемых файлов](docs/config.ru.md#игнорирование-не-отслеживаемых-файлов)
- [Настройка форматирования CHANGELOG](docs/config.ru.md#настройка-форматирования-changelog)
    - [Использование форматера, сохраняющего скоупы](docs/config.ru.md#использование-форматера-сохраняющего-скоупы)
    - [Настройка человекочитаемых заголовков для скоупов](docs/config.ru.md#настройка-человекочитаемых-заголовков-для-скоупов)
    - [Создание собственного форматера](docs/config.ru.md#создание-собственного-форматера)
- [Настройка сквошенных коммитов](docs/config.ru.md#настройка-сквошенных-коммитов)
    - [Объединяющий коммит по умолчанию](docs/config.ru.md#объединяющий-коммит-по-умолчанию)
    - [Определение сквошенного коммита через группу](docs/config.ru.md#определение-сквошенного-коммита-через-группу)
    - [Комбинированное определение сквошенного коммита](docs/config.ru.md#комбинированное-определение-сквошенного-коммита)
    - [Общие правила полного описания коммита](docs/config.ru.md#общие-правила-полного-описания-коммита)
- [Настройка парсера описания коммитов](docs/config.ru.md#настройка-парсера-описания-коммитов)
- [Отключение обновления версии в composer.json](docs/config.ru.md#отключение-обновления-версии-в-composerjson)
- [Передача произвольных параметров конфигурации](docs/config.ru.md#передача-произвольных-параметров-конфигурации)
- [Скрытие повторяющихся строк в CHANGELOG](docs/config.ru.md#скрытие-повторяющихся-строк-в-changelog)

## Описания коммитов

Для правильного функционирования утилиты описания коммитов необходимо формировать по следующему шаблону

```
<type>[(scope)][!]: <description>

[body]
```

*type* - тип коммита. Рекомендуется использовать типовой для конкретного проекта список. По типу изменения будут
группироваться в истории изменений. Если указан не зарегистрированный тип - изменение будет отнесено к типу
по-умолчанию. Так же имеет значение тип настроенный как тип относящийся к новому функционалу (по-умолчанию: feat) - при
автоопределнии в случае наличия среди изменений с прошлого релиза коммитов с таким типом будет изменена минорная версия

*scope* - Не обязательный. Группа к которой относится коммит

*!* - Признак того, что коммит нарушает обратную совместимость. При автоопределении типа изменений и при наличии такого
признака будет увеличена мажорная версия

*description* - Короткое описание.

*body* - Подробное описание коммита в работе утилиты не используется.

Примеры:

```
feat(router): New endpoint
```

```
doc: Described all features
```

```
feat!: Removed old API endpoints
```

## Типы коммитов по умолчанию

| Тип        | Назначение                                                           |
|------------|----------------------------------------------------------------------|
| `feat`     | Добавление нового функционала                                        |
| `fix`      | Исправление ошибок                                                   |
| `chore`    | Рутинные задачи (например, обновление зависимостей)                  |
| `docs`     | Изменения в документации                                             |
| `style`    | Форматирование кода (отступы, пробелы и т.д.)                        |
| `refactor` | Рефакторинг кода без добавления новых функций или исправления ошибок |
| `test`     | Добавление или изменение тестов                                      |
| `perf`     | Оптимизация производительности                                       |
| `ci`       | Настройка непрерывной интеграции (CI)                                |
| `build`    | Изменения, связанные со сборкой проекта                              |
| `other`    | Все остальные изменения, не попадающие под стандартные категории     |

## Интеграция с CI/CD

Скрипт можно интегрировать c CI/CD. При возникновении ошибок он возвращает различные коды

| Код | Описание                                |
|-----|-----------------------------------------|
| 10  | Ошибка конфигурации composer            |
| 20  | Ошибка ветки Git не основная            |
| 30  | Незакоммиченные изменения в репозитории |
| 40  | В репозитории нет изменений             |
| 50  | Неверный конфигурационный файл          |
| 60  | Ошибка выполнения команды git           |
| 70  | Неверный тип изменения версии           |
| 80  | Ошибка файла CHANGELOG.md               |
| 90  | Неизвестное свойство конфигурации       |
| 100 | Не задана конфигурация                  |
| 500 | Прочие ошибки                           |

Можете использовать в командной строке, например:

```bash
./vendor/bin/vs-version-increment && echo 'Ok' || echo 'Error'
```

Пример для Github Actions

```
jobs:
  version-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run version increment script
        run: ./vendor/bin/vs-version-increment
```

## Обработка ошибок в пользовательских расширениях

При разработке пользовательских расширений или интеграций для этого инструмента, таких как собственные парсеры,
форматтеры или исполнители VCS, вы должны использовать класс `UserException` для обработки ошибок, специфичных для вашей
реализации. Это гарантирует, что коды ошибок, генерируемые вашими расширениями, будут уникальными и не будут
конфликтовать с системными кодами ошибок.

### Ключевые моменты:

- **Зарезервированные коды ошибок**: Класс `UserException` гарантирует, что все пользовательские коды ошибок будут
  сдвинуты на `5000`. Это гарантирует, что пользовательские коды ошибок не пересекаются с системными кодами (
  ниже `5000`).
- **Пример использования**:
  ```php
  use Vasoft\VersionIncrement\Exceptions\UserException;

  throw new UserException(
      code: 100, // Ваш пользовательский код ошибки (будет преобразован в 5100)
      message: 'Пользовательское сообщение об ошибке, описывающее проблему.'
  );
  ```
- **Рекомендации**:
    - Используйте описательные сообщения об ошибках, чтобы помочь пользователям понять причину ошибки.
    - Документируйте значение пользовательских кодов ошибок в документации вашего расширения.
    - Избегайте использования кодов ошибок ниже `5000`, так как они зарезервированы для системных ошибок.

Следуя этим рекомендациям, вы можете обеспечить бесшовную интеграцию ваших пользовательских расширений с инструментом,
сохраняя при этом ясность и согласованность в обработке ошибок.

## Примеры конфигураций

Чтобы помочь вам быстрее начать работу с библиотекой, предлагаю готовые примеры конфигураций для различных сценариев
использования.

### 1. Конфигурация для Keep a Changelog

Этот пример конфигурации предназначен для проектов, которые следуют
стандарту [Keep a Changelog](https://keepachangelog.com/). Он отображает изменения в виде
категорий (`Added`, `Changed`, `Deprecated`, `Removed`, `Fixed`, `Security`), что делает changelog удобным для чтения.

-
*Файл:* [`examples/keepachangelog.php`](https://github.com/Voral/vs-version-incrementor/blob/master/examples/keepachangelog.php)

## Полезные ссылки

- [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/)
- [Semantic Versioning](https://semver.org/)
- [Репозиторий проекта](https://github.com/Voral/vs-version-incrementor)
